# Use an official OpenJDK runtime as a parent image
FROM eclipse-temurin:21-jdk-jammy AS builder

# Set the working directory in the container
WORKDIR /app

# Define build path to ./
ARG PROJECT_PATH=./
# Copy the build.gradle and settings.gradle files
COPY ${PROJECT_PATH}/build.gradle.kts ${PROJECT_PATH}/settings.gradle.kts ${PROJECT_PATH}/gradlew ${PROJECT_PATH}/gradlew.bat ./

# Copy the source code
COPY ${PROJECT_PATH}/src ./src

# Copy the gradle directory
COPY ${PROJECT_PATH}/gradle ./gradle

# Set the permissions for the gradlew file
RUN chmod +x gradlew

# Build the application without running tests
RUN ./gradlew clean build -x test



# Stage 2: Create the runtime image
FROM openjdk:24-ea-21-slim
WORKDIR /app
ARG JWT_SECRET
ARG PROJECT_PATH
ARG JAVA_VERSION
ARG MICROSERVICE_NAME
ARG USERS_SERVICE_URI
ARG AUTH_ROUTE_URI
ARG LOCATIONS_SERVICE_URI
ARG CATEGORY_SERVICE_URI
ARG RESERVATION_SERVICE_URI
ARG REVIEW_SERVICE_URI
ARG NOTIFICATION_SERVICE_URI
ARG MESSAGERIE_SERVICE_URI

ENV JWT_SECRET=${JWT_SECRET}
ENV JAVA_VERSION=${JAVA_VERSION}
ENV PROJECT_PATH=${PROJECT_PATH}
ENV MICROSERVICE_NAME=${MICROSERVICE_NAME}
ENV USERS_SERVICE_URI=${USERS_SERVICE_URI}
ENV AUTH_ROUTE_URI=${AUTH_ROUTE_URI}
ENV LOCATIONS_SERVICE_URI=${LOCATIONS_SERVICE_URI}
ENV CATEGORY_SERVICE_URI=${CATEGORY_SERVICE_URI}
ENV RESERVATION_SERVICE_URI=${RESERVATION_SERVICE_URI}
ENV REVIEW_SERVICE_URI=${REVIEW_SERVICE_URI}
ENV NOTIFICATION_SERVICE_URI=${NOTIFICATION_SERVICE_URI}
ENV MESSAGERIE_SERVICE_URI=${MESSAGERIE_SERVICE_URI}

# Log the environment
RUN echo "JWT_SECRET: ${JWT_SECRET}"
RUN echo "JAVA_VERSION: ${JAVA_VERSION}"
RUN echo "PROJECT_PATH: ${PROJECT_PATH}"
RUN echo "MICROSERVICE_NAME: ${MICROSERVICE_NAME}"
RUN echo "USERS_SERVICE_URI: ${USERS_SERVICE_URI}"
RUN echo "AUTH_ROUTE_URI: ${AUTH_ROUTE_URI}"
RUN echo "LOCATIONS_SERVICE_URI: ${LOCATIONS_SERVICE_URI}"
RUN echo "CATEGORY_SERVICE_URI: ${CATEGORY_SERVICE_URI}"
RUN echo "RESERVATION_SERVICE_URI: ${RESERVATION_SERVICE_URI}"
RUN echo "REVIEW_SERVICE_URI: ${REVIEW_SERVICE_URI}"
RUN echo "NOTIFICATION_SERVICE_URI: ${NOTIFICATION_SERVICE_URI}"
RUN echo "MESSAGERIE_SERVICE_URI: ${MESSAGERIE_SERVICE_URI}"


COPY --from=builder /app/build/libs/*.jar /app/myapp.jar
ENTRYPOINT ["java", "-jar", "/app/myapp.jar"]
